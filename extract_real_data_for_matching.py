#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ì‹¤ì œ ì„œìš¸ì‹œë¯¼ ì¹´ë“œ ë°ì´í„°ì—ì„œ Level 2 ë§¤ì¹­ìš© ë°ì´í„° ì¶”ì¶œ
1. íŒŒì¼ 6: êµ¬ë³„ ì—°ë ¹ëŒ€/ì„±ë³„ ë¹„ìœ¨
2. íŒŒì¼ 1: êµ¬ë³„ ì†Œë¹„ ì¹´í…Œê³ ë¦¬ ë¹„ìœ¨
"""

import pandas as pd
import numpy as np
import json
import os
from collections import defaultdict


# ============================================================================
# í–‰ì •ë™ ì½”ë“œ â†’ êµ¬ ë§¤í•‘ í…Œì´ë¸”
# ============================================================================

ADMIN_CODE_TO_GU = {
    '11110': 'ì¢…ë¡œêµ¬',
    '11140': 'ì¤‘êµ¬',
    '11170': 'ìš©ì‚°êµ¬',
    '11200': 'ì„±ë™êµ¬',
    '11215': 'ê´‘ì§„êµ¬',
    '11230': 'ë™ëŒ€ë¬¸êµ¬',
    '11260': 'ì¤‘ë‘êµ¬',
    '11290': 'ì„±ë¶êµ¬',
    '11305': 'ê°•ë¶êµ¬',
    '11320': 'ë„ë´‰êµ¬',
    '11350': 'ë…¸ì›êµ¬',
    '11380': 'ì€í‰êµ¬',
    '11410': 'ì„œëŒ€ë¬¸êµ¬',
    '11440': 'ë§ˆí¬êµ¬',
    '11470': 'ì–‘ì²œêµ¬',
    '11500': 'ê°•ì„œêµ¬',
    '11530': 'êµ¬ë¡œêµ¬',
    '11545': 'ê¸ˆì²œêµ¬',
    '11560': 'ì˜ë“±í¬êµ¬',
    '11590': 'ë™ì‘êµ¬',
    '11620': 'ê´€ì•…êµ¬',
    '11650': 'ì„œì´ˆêµ¬',
    '11680': 'ê°•ë‚¨êµ¬',
    '11710': 'ì†¡íŒŒêµ¬',
    '11740': 'ê°•ë™êµ¬'
}


# ============================================================================
# 1. íŒŒì¼ 6: êµ¬ë³„ ì¸êµ¬í†µê³„ ì¶”ì¶œ
# ============================================================================

def extract_demographics():
    """íŒŒì¼ 6ì—ì„œ êµ¬ë³„ ì—°ë ¹ëŒ€/ì„±ë³„ ë¹„ìœ¨ ì¶”ì¶œ"""
    
    print("="*100)
    print("1ë‹¨ê³„: êµ¬ë³„ ì¸êµ¬í†µê³„ ë°ì´í„° ì¶”ì¶œ (íŒŒì¼ 6)")
    print("="*100)
    
    # ë°ì´í„° ë¡œë“œ
    print("\në°ì´í„° ë¡œë”© ì¤‘...")
    df = pd.read_csv('data_2/6.ì„œìš¸ì‹œ ë‚´êµ­ì¸ ì„±ë³„ ì—°ë ¹ëŒ€ë³„(í–‰ì •ë™ë³„).csv', encoding='cp949')
    print(f"âœ“ ë¡œë“œ ì™„ë£Œ: {len(df):,}í–‰")
    
    # í–‰ì •ë™ì½”ë“œ â†’ êµ¬ ë³€í™˜
    df['êµ¬ì½”ë“œ'] = df['ê°€ë§¹ì í–‰ì •ë™ì½”ë“œ'].astype(str).str[:5]
    df['êµ¬'] = df['êµ¬ì½”ë“œ'].map(ADMIN_CODE_TO_GU)
    
    # ëˆ„ë½ ì²´í¬
    missing = df[df['êµ¬'].isna()]
    if len(missing) > 0:
        print(f"âš ï¸  ë§¤í•‘ ì•ˆ ëœ êµ¬ì½”ë“œ: {missing['êµ¬ì½”ë“œ'].unique()}")
    
    df = df[df['êµ¬'].notna()]
    print(f"âœ“ êµ¬ ë§¤í•‘ ì™„ë£Œ: {df['êµ¬'].nunique()}ê°œ êµ¬")
    
    # ì—°ë ¹ëŒ€ ì •ë¦¬
    age_mapping = {
        '20ì„¸ë¯¸ë§Œ': '10ëŒ€',
        '20_29ì„¸': '20ëŒ€',
        '30_39ì„¸': '30ëŒ€',
        '40_49ì„¸': '40ëŒ€',
        '50_59ì„¸': '50ëŒ€',
        '60_69ì„¸': '60ëŒ€ì´ìƒ',
        '70ì„¸ì´ìƒ': '60ëŒ€ì´ìƒ'
    }
    df['ì—°ë ¹ëŒ€_ì •ë¦¬'] = df['ì—°ë ¹ëŒ€'].map(age_mapping)
    
    # êµ¬ë³„ ì—°ë ¹ëŒ€ ì§‘ê³„
    print("\nì—°ë ¹ëŒ€ë³„ ì§‘ê³„ ì¤‘...")
    gu_age = df.groupby(['êµ¬', 'ì—°ë ¹ëŒ€_ì •ë¦¬'])['ì¹´ë“œì´ìš©ê±´ìˆ˜ê³„'].sum().reset_index()
    
    # í”¼ë²—
    gu_age_pivot = gu_age.pivot(index='êµ¬', columns='ì—°ë ¹ëŒ€_ì •ë¦¬', values='ì¹´ë“œì´ìš©ê±´ìˆ˜ê³„')
    
    # 60ëŒ€ì´ìƒ í†µí•©
    if '60ëŒ€ì´ìƒ' in gu_age_pivot.columns:
        gu_age_pivot['60ëŒ€ì´ìƒ'] = gu_age_pivot['60ëŒ€ì´ìƒ'].fillna(0)
    
    # ë¹„ìœ¨ ê³„ì‚°
    gu_age_ratio = gu_age_pivot.div(gu_age_pivot.sum(axis=1), axis=0) * 100
    
    print("\nâœ“ êµ¬ë³„ ì—°ë ¹ëŒ€ ë¹„ìœ¨:")
    print(gu_age_ratio.round(1))
    
    # ì„±ë³„ ì§‘ê³„
    print("\nì„±ë³„ ì§‘ê³„ ì¤‘...")
    gu_gender = df.groupby(['êµ¬', 'ì„±ë³„'])['ì¹´ë“œì´ìš©ê±´ìˆ˜ê³„'].sum().reset_index()
    gu_gender_pivot = gu_gender.pivot(index='êµ¬', columns='ì„±ë³„', values='ì¹´ë“œì´ìš©ê±´ìˆ˜ê³„')
    gu_gender_ratio = gu_gender_pivot.div(gu_gender_pivot.sum(axis=1), axis=0) * 100
    
    print("\nâœ“ êµ¬ë³„ ì„±ë³„ ë¹„ìœ¨:")
    print(gu_gender_ratio.round(1))
    
    return gu_age_ratio, gu_gender_ratio


# ============================================================================
# 2. íŒŒì¼ 1: êµ¬ë³„ ì†Œë¹„ íŒ¨í„´ ì¶”ì¶œ
# ============================================================================

# ì—…ì¢… â†’ ì†Œë¹„ ì¹´í…Œê³ ë¦¬ ë§¤í•‘
INDUSTRY_TO_CATEGORY = {
    # ì‹ë£Œí’ˆ
    'í•œì‹': 'ì‹ë£Œí’ˆ',
    'ì¤‘ì‹': 'ì‹ë£Œí’ˆ',
    'ì¼ì‹': 'ì‹ë£Œí’ˆ',
    'ì„œì–‘ì‹': 'ì‹ë£Œí’ˆ',
    'ë™ë‚¨ì•„/ì¸ë„ìŒì‹': 'ì‹ë£Œí’ˆ',
    'ê¸°íƒ€ìš”ì‹': 'ì‹ë£Œí’ˆ',
    'ì œê³¼ì ': 'ì‹ë£Œí’ˆ',
    'íŒ¨ìŠ¤íŠ¸í‘¸ë“œ': 'ì‹ë£Œí’ˆ',
    'ì»¤í”¼': 'ì‹ë£Œí’ˆ',
    'ì£¼ì ': 'ì‹ë£Œí’ˆ',
    'í¸ì˜ì ': 'ì‹ë£Œí’ˆ',
    'ìŠˆí¼ë§ˆì¼“ê¸°ì—…í˜•': 'ì‹ë£Œí’ˆ',
    'ëŒ€í˜•ë§ˆíŠ¸': 'ì‹ë£Œí’ˆ',
    'ê¸°íƒ€ì‹í’ˆ': 'ì‹ë£Œí’ˆ',
    'ìŒì‹ì ': 'ì‹ë£Œí’ˆ',
    
    # ì˜ë¥˜ì‹ ë°œ
    'ì˜ë³µ/ì˜ë¥˜': 'ì˜ë¥˜ì‹ ë°œ',
    'êµ¬ë‘/ì‹ ë°œ': 'ì˜ë¥˜ì‹ ë°œ',
    'ê°€ë°©': 'ì˜ë¥˜ì‹ ë°œ',
    'íŒ¨ì…˜ì¡í™”': 'ì˜ë¥˜ì‹ ë°œ',
    'ì‹œê³„/ê·€ê¸ˆì†': 'ì˜ë¥˜ì‹ ë°œ',
    
    # ìƒí™œìš©í’ˆ
    'ìƒí™œì¡í™”/ìˆ˜ì…ìƒí’ˆì ': 'ìƒí™œìš©í’ˆ',
    'í™”ì¥í’ˆ': 'ìƒí™œìš©í’ˆ',
    'ë¯¸ìš©ì‹¤': 'ìƒí™œìš©í’ˆ',
    'ì„¸íƒì†Œ': 'ìƒí™œìš©í’ˆ',
    'ì‹¸ìš°ë‚˜/ëª©ìš•íƒ•': 'ìƒí™œìš©í’ˆ',
    
    # ì˜ë£Œ
    'ì•½êµ­': 'ì˜ë£Œ',
    'ë³‘ì›': 'ì˜ë£Œ',
    'ì˜ì›': 'ì˜ë£Œ',
    'í•œì˜ì›': 'ì˜ë£Œ',
    'ë™ë¬¼ë³‘ì›': 'ì˜ë£Œ',
    
    # êµí†µ
    'ì£¼ìœ ì†Œ': 'êµí†µ',
    'ìë™ì°¨ì •ë¹„': 'êµí†µ',
    'ìë™ì°¨íŒë§¤': 'êµí†µ',
    'íƒì‹œ': 'êµí†µ',
    
    # ì—¬ê°€
    'ìŠ¤í¬ì¸ ': 'ì—¬ê°€',
    'í—¬ìŠ¤ì¥': 'ì—¬ê°€',
    'ì‹¤ë‚´/ì‹¤ì™¸ê³¨í”„ì¥': 'ì—¬ê°€',
    'ë ˆì €ì—…ì†Œ': 'ì—¬ê°€',
    'ì—¬í–‰ì‚¬': 'ì—¬ê°€',
    
    # ë¬¸í™”
    'ì„œì /ë¬¸êµ¬': 'ë¬¸í™”',
    'ì˜ìƒ/ìŒë°˜': 'ë¬¸í™”',
    'ì‚¬ì§„ê´€': 'ë¬¸í™”',
    'ê³µì—°': 'ë¬¸í™”',
    'ì˜í™”ê´€': 'ë¬¸í™”',
    
    # êµìœ¡
    'í•™ì›/í•™ìŠµì§€': 'êµìœ¡',
    'êµìœ¡': 'êµìœ¡',
    
    # ì˜¤ë½
    'ê²Œì„ë°©/ì˜¤ë½ì‹¤': 'ì˜¤ë½',
    'ë…¸ë˜ë°©': 'ì˜¤ë½',
    'PCë°©': 'ì˜¤ë½'
}


def extract_consumption_pattern():
    """íŒŒì¼ 1ì—ì„œ êµ¬ë³„ ì†Œë¹„ ì¹´í…Œê³ ë¦¬ ë¹„ìœ¨ ì¶”ì¶œ"""
    
    print("\n" + "="*100)
    print("2ë‹¨ê³„: êµ¬ë³„ ì†Œë¹„ íŒ¨í„´ ë°ì´í„° ì¶”ì¶œ (íŒŒì¼ 1)")
    print("="*100)
    
    # ë°ì´í„° ë¡œë“œ
    print("\në°ì´í„° ë¡œë”© ì¤‘...")
    df = pd.read_csv('data_2/1.ì„œìš¸ì‹œë¯¼ì˜ ì¼ë³„ ì†Œë¹„ì§€ì—­ë³„(í–‰ì •ë™).csv', encoding='cp949')
    print(f"âœ“ ë¡œë“œ ì™„ë£Œ: {len(df):,}í–‰")
    
    # êµ¬ ì •ë¦¬ (ì„œìš¸íŠ¹ë³„ì‹œ ì œê±°)
    df['êµ¬'] = df['ê°€ë§¹ì ì£¼ì†Œì‹œêµ°êµ¬'].str.replace('ì„œìš¸íŠ¹ë³„ì‹œ', '').str.strip()
    
    # í‘œì¤€í™”
    gu_name_mapping = {
        'ì¢…ë¡œêµ¬': 'ì¢…ë¡œêµ¬',
        'ì¤‘êµ¬': 'ì¤‘êµ¬',
        'ìš©ì‚°êµ¬': 'ìš©ì‚°êµ¬',
        'ì„±ë™êµ¬': 'ì„±ë™êµ¬',
        'ê´‘ì§„êµ¬': 'ê´‘ì§„êµ¬',
        'ë™ëŒ€ë¬¸êµ¬': 'ë™ëŒ€ë¬¸êµ¬',
        'ì¤‘ë‘êµ¬': 'ì¤‘ë‘êµ¬',
        'ì„±ë¶êµ¬': 'ì„±ë¶êµ¬',
        'ê°•ë¶êµ¬': 'ê°•ë¶êµ¬',
        'ë„ë´‰êµ¬': 'ë„ë´‰êµ¬',
        'ë…¸ì›êµ¬': 'ë…¸ì›êµ¬',
        'ì€í‰êµ¬': 'ì€í‰êµ¬',
        'ì„œëŒ€ë¬¸êµ¬': 'ì„œëŒ€ë¬¸êµ¬',
        'ë§ˆí¬êµ¬': 'ë§ˆí¬êµ¬',
        'ì–‘ì²œêµ¬': 'ì–‘ì²œêµ¬',
        'ê°•ì„œêµ¬': 'ê°•ì„œêµ¬',
        'êµ¬ë¡œêµ¬': 'êµ¬ë¡œêµ¬',
        'ê¸ˆì²œêµ¬': 'ê¸ˆì²œêµ¬',
        'ì˜ë“±í¬êµ¬': 'ì˜ë“±í¬êµ¬',
        'ë™ì‘êµ¬': 'ë™ì‘êµ¬',
        'ê´€ì•…êµ¬': 'ê´€ì•…êµ¬',
        'ì„œì´ˆêµ¬': 'ì„œì´ˆêµ¬',
        'ê°•ë‚¨êµ¬': 'ê°•ë‚¨êµ¬',
        'ì†¡íŒŒêµ¬': 'ì†¡íŒŒêµ¬',
        'ê°•ë™êµ¬': 'ê°•ë™êµ¬'
    }
    
    df['êµ¬'] = df['êµ¬'].map(gu_name_mapping)
    df = df[df['êµ¬'].notna()]
    
    print(f"âœ“ êµ¬ ì •ë¦¬ ì™„ë£Œ: {df['êµ¬'].nunique()}ê°œ êµ¬")
    
    # ì—…ì¢… â†’ ì¹´í…Œê³ ë¦¬ ë§¤í•‘
    df['ì¹´í…Œê³ ë¦¬'] = df['ì—…ì¢…ëŒ€ë¶„ë¥˜'].map(INDUSTRY_TO_CATEGORY)
    
    # ë§¤í•‘ ì•ˆ ëœ ì—…ì¢… í™•ì¸
    unmapped = df[df['ì¹´í…Œê³ ë¦¬'].isna()]['ì—…ì¢…ëŒ€ë¶„ë¥˜'].unique()
    if len(unmapped) > 0:
        print(f"\nâš ï¸  ë§¤í•‘ ì•ˆ ëœ ì—…ì¢…: {unmapped[:10]}")
        # ê¸°íƒ€ë¡œ ë¶„ë¥˜
        df['ì¹´í…Œê³ ë¦¬'] = df['ì¹´í…Œê³ ë¦¬'].fillna('ê¸°íƒ€')
    
    # êµ¬ë³„ ì¹´í…Œê³ ë¦¬ë³„ ì§‘ê³„
    print("\nì¹´í…Œê³ ë¦¬ë³„ ì§‘ê³„ ì¤‘...")
    gu_category = df.groupby(['êµ¬', 'ì¹´í…Œê³ ë¦¬'])['ì¹´ë“œì´ìš©ê¸ˆì•¡ê³„'].sum().reset_index()
    
    # í”¼ë²—
    gu_category_pivot = gu_category.pivot(index='êµ¬', columns='ì¹´í…Œê³ ë¦¬', values='ì¹´ë“œì´ìš©ê¸ˆì•¡ê³„')
    
    # ë¹„ìœ¨ ê³„ì‚°
    gu_category_ratio = gu_category_pivot.div(gu_category_pivot.sum(axis=1), axis=0) * 100
    
    print("\nâœ“ êµ¬ë³„ ì†Œë¹„ ì¹´í…Œê³ ë¦¬ ë¹„ìœ¨:")
    print(gu_category_ratio.round(1))
    
    return gu_category_ratio


# ============================================================================
# 3. í†µí•© ë° ì €ì¥
# ============================================================================

def integrate_and_save(gu_age_ratio, gu_gender_ratio, gu_category_ratio):
    """í†µí•© ë°ì´í„° ìƒì„± ë° ì €ì¥"""
    
    print("\n" + "="*100)
    print("3ë‹¨ê³„: í†µí•© í”„ë¡œí•„ ìƒì„±")
    print("="*100)
    
    integrated_profiles = {}
    
    # Level 1 ì ìˆ˜ ë¡œë“œ
    level1_df = pd.read_csv('outputs/seoul_25gu_level1_scores.csv', encoding='utf-8-sig')
    
    for gu in gu_age_ratio.index:
        if gu not in level1_df['êµ¬'].values:
            continue
        
        # Level 1 ì ìˆ˜
        l1_data = level1_df[level1_df['êµ¬'] == gu].iloc[0]
        
        # ì¸êµ¬í†µê³„
        age_dist = gu_age_ratio.loc[gu].to_dict()
        gender_dist = gu_gender_ratio.loc[gu].to_dict() if gu in gu_gender_ratio.index else {'ë‚¨': 50, 'ì—¬': 50}
        
        # ì†Œë¹„ íŒ¨í„´
        consumption = gu_category_ratio.loc[gu].to_dict() if gu in gu_category_ratio.index else {}
        
        integrated_profiles[gu] = {
            # Level 1 ì ìˆ˜
            'ì¢…í•©ì ìˆ˜': float(l1_data['ì¢…í•©ì ìˆ˜']),
            'ìƒì—…í™œë™ì ìˆ˜': float(l1_data['ìƒì—…í™œë™ì ìˆ˜']),
            'íŠ¹í™”ë„ì ìˆ˜': float(l1_data['íŠ¹í™”ë„ì ìˆ˜']),
            'ì¸êµ¬í†µê³„ì ìˆ˜': float(l1_data['ì¸êµ¬í†µê³„ì ìˆ˜']),
            'ê²½ì œë ¥ì ìˆ˜': float(l1_data['ê²½ì œë ¥ì ìˆ˜']),
            
            # Level 2ìš© ìƒì„¸ ë°ì´í„°
            'í‰ê· ì†Œë“': 4000000,  # ê¸°ë³¸ê°’ (ì†Œë“ ë°ì´í„°ì—ì„œ ì—…ë°ì´íŠ¸ í•„ìš”)
            
            'ì¸êµ¬í†µê³„': {k: round(float(v), 1) for k, v in age_dist.items()},
            
            'ì„±ë³„ë¶„í¬': {
                'ë‚¨ì„±': round(float(gender_dist.get('ë‚¨', 50)), 1),
                'ì—¬ì„±': round(float(gender_dist.get('ì—¬', 50)), 1)
            },
            
            'ì†Œë¹„íŒ¨í„´': {k: round(float(v), 1) for k, v in consumption.items()},
            
            'íŠ¹í™”ì—…ì¢…': [l1_data['ì£¼ìš”íŠ¹í™”ì—…ì¢…']],
            
            'íŠ¹ì§•': f"{l1_data['ë“±ê¸‰ì„¤ëª…']}, {l1_data['ì£¼ìš”íŠ¹í™”ì—…ì¢…']} íŠ¹í™”"
        }
    
    # JSON ì €ì¥
    os.makedirs('outputs', exist_ok=True)
    
    json_file = 'outputs/integrated_gu_profiles_real_data.json'
    with open(json_file, 'w', encoding='utf-8') as f:
        json.dump(integrated_profiles, f, ensure_ascii=False, indent=2)
    
    print(f"\nâœ“ í†µí•© í”„ë¡œí•„ ì €ì¥: {json_file}")
    print(f"âœ“ ì´ {len(integrated_profiles)}ê°œ êµ¬ í”„ë¡œí•„ ìƒì„±")
    
    # ìƒ˜í”Œ ì¶œë ¥
    print(f"\n[ìƒ˜í”Œ] ë§ˆí¬êµ¬ í”„ë¡œí•„:")
    if 'ë§ˆí¬êµ¬' in integrated_profiles:
        import json as json_module
        print(json_module.dumps(integrated_profiles['ë§ˆí¬êµ¬'], ensure_ascii=False, indent=2))
    
    return integrated_profiles


# ============================================================================
# ë©”ì¸ ì‹¤í–‰
# ============================================================================

def main():
    """ë©”ì¸ ì‹¤í–‰"""
    
    print("="*100)
    print("ì‹¤ì œ ì„œìš¸ì‹œë¯¼ ì¹´ë“œ ë°ì´í„° â†’ Level 2 ë§¤ì¹­ìš© ë°ì´í„° ì¶”ì¶œ")
    print("="*100)
    
    try:
        # 1. ì¸êµ¬í†µê³„ ì¶”ì¶œ
        gu_age_ratio, gu_gender_ratio = extract_demographics()
        
        # 2. ì†Œë¹„ íŒ¨í„´ ì¶”ì¶œ
        gu_category_ratio = extract_consumption_pattern()
        
        # 3. í†µí•© ë° ì €ì¥
        integrated_profiles = integrate_and_save(gu_age_ratio, gu_gender_ratio, gu_category_ratio)
        
        print("\n" + "="*100)
        print("âœ… ì‹¤ì œ ë°ì´í„° ì¶”ì¶œ ì™„ë£Œ!")
        print("="*100)
        
        print("\nğŸ“Š ì¶”ì¶œëœ ë°ì´í„°:")
        print(f"  â€¢ 25ê°œ êµ¬ë³„ ì—°ë ¹ëŒ€ ë¹„ìœ¨ (ì‹¤ì œ ì¹´ë“œ ì‚¬ìš© ê¸°ì¤€)")
        print(f"  â€¢ 25ê°œ êµ¬ë³„ ì„±ë³„ ë¹„ìœ¨ (ì‹¤ì œ ì¹´ë“œ ì‚¬ìš© ê¸°ì¤€)")
        print(f"  â€¢ 25ê°œ êµ¬ë³„ ì†Œë¹„ ì¹´í…Œê³ ë¦¬ ë¹„ìœ¨ (ì‹¤ì œ ì†Œë¹„ì•¡ ê¸°ì¤€)")
        
        print("\nğŸ’¡ ë‹¤ìŒ ë‹¨ê³„:")
        print("  â€¢ ì´ ë°ì´í„°ë¥¼ Level 2 ë§¤ì¹­ì— ì ìš©")
        print("  â€¢ ê°€ìƒ ë°ì´í„° â†’ ì‹¤ì œ ë°ì´í„° êµì²´")
        print("  â€¢ ë§¤ì¹­ ì •í™•ë„ ëŒ€í­ í–¥ìƒ!")
        
        return integrated_profiles
        
    except Exception as e:
        print(f"\nâŒ ì˜¤ë¥˜ ë°œìƒ: {e}")
        import traceback
        traceback.print_exc()
        return None


if __name__ == '__main__':
    result = main()



