# 🎯 개인화 지역 추천 시스템 - 전체 프로세스 & 데이터 흐름도

## 📋 **전체 프로세스 개요**

```
┌─────────────────────────────────────────────────────────────────────┐
│                     개인화 지역 추천 시스템                          │
│                                                                      │
│  INPUT: 사용자 프로필 (나이, 소득, 취향)                             │
│  OUTPUT: 맞춤형 지역 TOP 3 + 추천 이유                               │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 🔄 **전체 프로세스 상세 흐름도**

```
┌──────────────────────────────────────────────────────────────────────────┐
│  STEP 1: 데이터 수집 및 전처리                                            │
└──────────────────────────────────────────────────────────────────────────┘
                              ↓
        ┌─────────────────────┴──────────────────────┐
        ↓                                            ↓
┌──────────────────┐                      ┌──────────────────┐
│  외부 API 데이터  │                      │  내부 카드 데이터  │
└──────────────────┘                      └──────────────────┘
        ↓                                            ↓
┌─────────────────────────────────────────────────────────────────────┐
│  📁 수집된 데이터 (4개 소스)                                          │
│                                                                      │
│  1. 서울시민 카드 소비 데이터                                         │
│     • 파일 1: 일별 소비지역별(행정동).csv                            │
│     • 파일 6: 성별 연령대별(행정동별).csv                            │
│                                                                      │
│  2. 서울시 상주인구 데이터 (VwsmMegaRepopW)                          │
│     • 총인구, 성별, 연령대별, 가구 통계                              │
│                                                                      │
│  3. 서울시 소득·소비 데이터 (trdarNcmCnsmp)                          │
│     • 42,346개 상권 × 월평균소득 × 9대 지출 카테고리                 │
│                                                                      │
│  4. 서울시 GIS 영역 데이터 (TbgisMegaRelmW)                          │
│     • 좌표, 면적 (605.75㎢)                                         │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────────────────┐
│  STEP 2: Level 1 - 지역 객관적 평가 (Regional Quality Score)              │
└──────────────────────────────────────────────────────────────────────────┘
                              ↓
        ┌─────────────────────┼──────────────────────┐
        ↓                     ↓                      ↓
┌──────────────┐    ┌──────────────┐      ┌──────────────┐
│ 상업활동 점수 │    │ 특화도 점수   │      │ 인구통계 점수 │
│   (30%)      │    │   (25%)      │      │   (20%)      │
└──────────────┘    └──────────────┘      └──────────────┘
        ↓                     ↓                      ↓
                    ┌──────────────┐
                    │ 경제력 점수   │
                    │   (25%)      │
                    └──────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│  📊 Level 1 결과: 서울시 25개 구 품질 점수표                          │
│                                                                      │
│  순위  구      종합점수  상업활동  특화도  인구통계  경제력           │
│  1    중구      66.9     79.6    70.0    49.1    62.8             │
│  2    마포구     64.8     57.8    72.7    48.6    78.3             │
│  3    영등포구   64.1     48.1    80.2    48.2    80.0             │
│  ...                                                                │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────────────────┐
│  STEP 3: Level 2 - 사용자-지역 매칭 (User-Region Matching)                │
└──────────────────────────────────────────────────────────────────────────┘
                              ↓
        ┌─────────────────────┼──────────────────────┐
        ↓                     ↓                      ↓
┌──────────────┐    ┌──────────────┐      ┌──────────────┐
│ 인구통계 매칭 │    │ 소비패턴 매칭 │      │ 소득수준 매칭 │
│   (40%)      │    │   (35%)      │      │   (15%)      │
│              │    │ 코사인 유사도 │      │ 가격대 적정성 │
└──────────────┘    └──────────────┘      └──────────────┘
        ↓                     ↓                      ↓
                    ┌──────────────┐
                    │ 업종선호 매칭 │
                    │   (10%)      │
                    └──────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│  📊 Level 2 결과: 사용자별 매칭 점수표                                │
│                                                                      │
│  사용자: 20대 대학생                                                 │
│  구      L1품질  L2매칭  인구통계  소비패턴  소득  업종              │
│  마포구   64.8   81.9     78        98      70    60              │
│  중구     66.9   55.4     42        93      40     0              │
│  ...                                                                │
└─────────────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────────────────┐
│  STEP 4: 최종 추천 점수 계산 (Final Recommendation)                       │
│                                                                           │
│  공식: 최종점수 = (Level1_품질 / 100) × Level2_매칭                       │
└──────────────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────────┐
│  🎯 최종 추천 결과                                                    │
│                                                                      │
│  👤 사용자: 20대 대학생 김민수                                        │
│                                                                      │
│  🥇 1위: 마포구 (53.1점)                                             │
│     → 이유: 같은 연령대 많음, 문화·오락 특화, 가격 적정              │
│                                                                      │
│  🥈 2위: 영등포구 (37.2점)                                           │
│     → 이유: 소비 패턴 맞음, 직장인 밀집                              │
│                                                                      │
│  🥉 3위: 중구 (37.1점)                                               │
│     → 이유: 지역 품질 최고, 업종 다양성                              │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 📁 **각 단계별 사용 데이터 상세**

### **STEP 1: 데이터 수집 및 전처리**

#### **1-1. 서울시민 카드 소비 데이터**

| 파일명 | 역할 | 컬럼 | 행수 |
|--------|------|------|------|
| `data_2/1.서울시민의 일별 소비지역별(행정동).csv` | 소비 패턴 분석 | 기준일자, 가맹점주소시군구, 업종대분류, 카드이용금액계, 카드이용건수계 | 155,895 |
| `data_2/6.서울시 내국인 성별 연령대별(행정동별).csv` | 인구통계 분석 | 기준일자, 가맹점행정동코드, 성별, 연령대, 업종대분류, 카드이용금액계, 카드이용건수계 | 100,101 |

**활용:**
- **파일 1** → Level 2 소비패턴 매칭 (35%)
- **파일 6** → Level 2 인구통계 매칭 (40%)

---

#### **1-2. 서울시 상주인구 데이터 (API)**

| 항목 | 내용 |
|------|------|
| **API 이름** | VwsmMegaRepopW (서울시 상권분석서비스) |
| **데이터** | 총인구, 남성/여성 인구, 연령대별(10~60대이상), 가구수 |
| **기간** | 2019Q1 ~ 2025Q1 (분기별) |
| **최신 값** | 총인구 9,360,421명, 인구밀도 15,452명/㎢ (2025Q1) |

**저장 위치:**
- `outputs/seoul_population_data.csv`
- `outputs/seoul_population_summary.csv`

**활용:**
- Level 1 인구통계 점수 (20%)
- Level 2 인구통계 매칭 보조 데이터

---

#### **1-3. 서울시 소득·소비 데이터 (API)**

| 항목 | 내용 |
|------|------|
| **API 이름** | trdarNcmCnsmp (상권별 소득·소비) |
| **데이터** | 월평균소득, 9대 지출 카테고리 (식료품, 의류, 생활용품, 의료, 교통, 여가, 문화, 교육, 오락) |
| **규모** | 42,346개 상권 |
| **평균 소득** | 3,384,950원 |

**저장 위치:**
- `outputs/seoul_income_consumption_data.csv`
- `outputs/income_consumption_summary.csv`

**활용:**
- Level 1 경제력 점수 (25%)
- Level 2 소득수준 매칭 (15%)
- Level 2 소비패턴 매칭 보조 데이터

---

#### **1-4. 서울시 GIS 영역 데이터 (API)**

| 항목 | 내용 |
|------|------|
| **API 이름** | TbgisMegaRelmW (GIS 광역 영역 정보) |
| **데이터** | 중심 X좌표, Y좌표, 면적 |
| **면적** | 605.75 ㎢ |
| **좌표** | TM 좌표계 (X: 199,275, Y: 450,264) |

**저장 위치:**
- `outputs/seoul_gis_area.csv`
- `outputs/seoul_gis_area.json`

**활용:**
- 공간 분석 기준점
- 인구밀도 계산 (인구 / 면적)
- 지도 시각화 (향후)

---

### **STEP 2: Level 1 - 지역 객관적 평가**

#### **2-1. 상업활동 점수 (30%)**

**사용 데이터:**
```python
출처: outputs/seoul_all_gu_final.csv (기존 분석 결과)

사용 컬럼:
- 업종다양성: "보통(14개)", "높음(15개)" 등
- 소비안정성: 변동계수(CV) 값

계산:
1. 업종 다양성 점수 = min(업종수 × 6.67, 100)
2. 안정성 점수 = max(0, 100 - CV × 3)
3. 상업활동 = 다양성 × 0.6 + 안정성 × 0.4
```

---

#### **2-2. 특화도 점수 (25%)**

**사용 데이터:**
```python
출처: outputs/seoul_all_gu_final.csv

사용 컬럼:
- 특징: "한식 특화 (90.5%)", "학원/학습지 특화 (31.4%)" 등

계산:
1. 특화 비율 추출: 31.4%, 90.5% 등
2. 점수화:
   - 70% 이상: 90-100점
   - 50-70%: 70-90점
   - 30-50%: 50-70점
```

---

#### **2-3. 인구통계 점수 (20%)**

**사용 데이터:**
```python
출처 1: outputs/seoul_all_gu_cv.csv
- 변동계수(%) 값 → 인구 활동 안정성

출처 2: outputs/seoul_population_summary.csv (보조)
- 총인구, 연령대별 인구

계산:
CV 기반 안정성 점수 = max(0, 100 - CV × 3)
```

---

#### **2-4. 경제력 점수 (25%)**

**사용 데이터:**
```python
출처: outputs/seoul_all_gu_final.csv

사용 컬럼:
- 성장률: "+2.00% (↑상승)", "-0.79% (→유지)" 등

계산:
1. 상승(↑): 70 + min(성장률 × 5, 30)
2. 유지(→): 60 + abs(성장률) × 2
3. 하락(↓): 50 + max(성장률 × 10, -30)
```

---

#### **2-5. Level 1 종합 점수**

**공식:**
```python
종합점수 = (
    상업활동점수 × 0.30 +
    특화도점수 × 0.25 +
    인구통계점수 × 0.20 +
    경제력점수 × 0.25
)
```

**결과 저장:**
- `outputs/seoul_25gu_level1_scores.csv`
- `outputs/서울시_25개구_지역점수표_Level1.md`

---

### **STEP 3: Level 2 - 사용자-지역 매칭**

#### **3-1. 인구통계 매칭 (40%)**

**사용 데이터:**
```python
출처: data_2/6.서울시 내국인 성별 연령대별(행정동별).csv

처리 과정:
1. 행정동코드 → 구 변환
2. 구별 연령대 집계:
   df.groupby(['구', '연령대'])['카드이용건수계'].sum()
3. 비율 계산:
   마포구 20대 비율 = 42.3%
   
매칭 로직:
사용자 연령대(20대) vs 지역 20대 비율(42%)
→ 점수 = min(42 × 2, 100) = 84점
```

---

#### **3-2. 소비패턴 매칭 (35%)**

**사용 데이터:**
```python
출처 1: data_2/1.서울시민의 일별 소비지역별(행정동).csv

처리 과정:
1. 구별 업종별 소비액 집계
2. 업종 → 9대 카테고리 매핑:
   한식, 제과점 → 식료품
   의류, 패션잡화 → 의류신발
   ...
3. 카테고리별 비율 계산

출처 2: outputs/seoul_income_consumption_data.csv (보조)
- 상권별 9대 지출 비율 참고

매칭 로직:
코사인 유사도(사용자_소비벡터, 지역_소비벡터)
→ 점수 = 유사도 × 100
```

---

#### **3-3. 소득수준 매칭 (15%)**

**사용 데이터:**
```python
출처: outputs/seoul_income_consumption_data.csv

사용 컬럼:
- MT_AVRG_INCOME_AMT (월평균소득)

구별 평균 계산:
중구 평균소득 = 4,500,000원
마포구 평균소득 = 3,200,000원

매칭 로직:
비율 = 사용자소득 / 지역평균소득
if 0.8 ≤ 비율 ≤ 1.2: 100점
elif 0.6 ≤ 비율 < 0.8: 70점
else: 40점
```

---

#### **3-4. 업종선호 매칭 (10%)**

**사용 데이터:**
```python
출처: outputs/seoul_all_gu_final.csv

사용 컬럼:
- 특징: 특화 업종 정보

추출:
마포구 → ['카페', '술집', '클럽', '공연장']
강남구 → ['학원', '학습지', '고급레스토랑']

매칭 로직:
교집합 = 사용자_선호 ∩ 지역_특화
점수 = (교집합 개수 / 사용자_선호 개수) × 100
```

---

#### **3-5. Level 2 종합 매칭 점수**

**공식:**
```python
매칭점수 = (
    인구통계_매칭 × 0.40 +
    소비패턴_매칭 × 0.35 +
    소득수준_매칭 × 0.15 +
    업종선호_매칭 × 0.10
)
```

**결과 저장:**
- `outputs/level2_matching_results.csv`
- `outputs/Level2_매칭결과_5개구.md`

---

### **STEP 4: 최종 추천 점수**

**사용 데이터:**
```python
입력 1: Level 1 품질 점수 (outputs/seoul_25gu_level1_scores.csv)
입력 2: Level 2 매칭 점수 (outputs/level2_matching_results.csv)

공식:
최종점수 = (Level1_품질점수 / 100) × Level2_매칭점수

예시:
마포구 → 20대 학생
= (64.8 / 100) × 81.9
= 53.1점
```

---

## 📊 **데이터 흐름 요약표**

| 단계 | 입력 데이터 | 출력 데이터 | 역할 |
|------|------------|------------|------|
| **STEP 1** | 외부 API + 카드 데이터 | 4개 통합 데이터셋 | 원시 데이터 수집 |
| **STEP 2** | 통합 데이터 | 25개 구 품질 점수표 | 지역 객관적 평가 |
| **STEP 3** | 사용자 프로필 + 카드 데이터 | 사용자-지역 매칭표 | 개인화 매칭 |
| **STEP 4** | Level 1 + Level 2 | 최종 추천 TOP 3 | 통합 추천 |

---

## 🎯 **핵심 데이터 매핑**

```
서울시민 카드 데이터
├─ 파일 1 (소비 지역별)
│  └→ Level 2 소비패턴 매칭 (35%)
│  └→ Level 1 상업활동 점수 (30%)
│
└─ 파일 6 (성별 연령대별)
   └→ Level 2 인구통계 매칭 (40%)
   └→ Level 1 인구통계 점수 (20%)

서울시 API 데이터
├─ 상주인구 (VwsmMegaRepopW)
│  └→ 인구밀도 계산
│  └→ 연령대 분포 검증
│
├─ 소득·소비 (trdarNcmCnsmp)
│  └→ Level 2 소득수준 매칭 (15%)
│  └→ Level 1 경제력 점수 (25%)
│
└─ GIS 영역 (TbgisMegaRelmW)
   └→ 공간 분석 기준
   └→ 인구밀도 = 인구 / 면적
```

---

## 📝 **결론**

✅ **4개 데이터 소스** → 완전 통합
✅ **2단계 평가 시스템** → Level 1 (품질) × Level 2 (매칭)
✅ **실제 데이터 기반** → 주관 배제, 객관적 추천
✅ **확장 가능** → 25개 구 → 전체 상권으로 확대 가능

이제 완벽하게 이해되셨나요? 😊



